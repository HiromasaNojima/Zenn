---
publication_name: "smartshopping"
title: "コードを削除するときは呼び出し側から削除していくとうまくいった"
emoji: "🗑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---


こんにちは、バックエンドを中心に開発をしています、野島といいます。
先日、廃止された機能のコードを約2,400行削除しました。

実は、このコードの削除について1度失敗しています。
そこで、失敗した手順と、成功した手順を共有します。
コード削除に関する情報は、よいコードを書くこと方法より情報が少ないと思っていて、知見共有に意味があると思うので記事を書きます。

失敗した手順も成功した手順も、着手前に削除対象の機能が全く呼び出されていないことは確認済みの状態で着手しています。

## 失敗した手順

呼び出しが多い箇所から削除したら、失敗しました。
具体的に言うと、弊社はクリーンアーキテクチャを採用しているのですが、円の中心のドメイン層から削除しました。

[クリーンアーキテクチャの円]

廃止した機能のコードの重要なコードはドメイン層にあるはずで、削除することによってコンパイルエラー起こす箇所を順々に削除していけば、全て削除できる。
と思って、この層から削除を始めたのですが、次の落とし穴がありました。

- 作業を小さく区切れない
- 小さく区切れないので、変更内容がバグを起こさない自信を持てない

### 作業を小さく区切れない

xxxx

### 小さく区切れないので、変更内容がバグを起こさない自信を持てない

xxx

## 成功した手順

呼び出されていることが多いコードから削除すると、連鎖的にコンパイルエラーが発生して削除作業の区切りをつけるのが難しく、変更内容にバグがないことに自信が持てない、と言うのが問題でした。
なので逆に、呼び出し側から削除することにしましたた。

具体的に言うと、クリーンアーキテクチャの外側、　、から削除しました。

[クリーンアーキテクチャの円]

呼び出し側から順々に削除していくと、あまりコンパイルエラーは起きません。
自分が作業に区切りをつけたい任意のタイミングでPRを作ることができます。
PR一つ一つの変更行数を少なくすることができ、変更内容に問題ないことを確認できます。自信を持ちながら削除作業を進めることができます。

実際の作業はPRを11個にわけて行なっております。
参考に削除行数を集計をするときに利用した[関数](https://zenn.dev/link/comments/ee9da5576c7fd5)の出力を載せます。

```
pr counts: 11
Processing PR: 1342
Deletions in PR 1342:       46
Processing PR: 1341
Deletions in PR 1341:      253
Processing PR: 1340
Deletions in PR 1340:      198
Processing PR: 1339
Deletions in PR 1339:      275
Processing PR: 1338
Deletions in PR 1338:       93
Processing PR: 1337
Deletions in PR 1337:      351
Processing PR: 1336
Deletions in PR 1336:      370
Processing PR: 1334
Deletions in PR 1334:      120
Processing PR: 1333
Deletions in PR 1333:      273
Processing PR: 1331
Deletions in PR 1331:      134
Processing PR: 1328
Deletions in PR 1328:      292
Total deletions for merged or closed PRs with label 'xxx' in repo 'yyy': 2405
```

## まとめ

コードを削除する手順において、失敗した手順と成功した手順を共有しました。
作業を小さく区切って、コントローラブルな状態で進めるために、呼び出されていることが少ない層から削除することをオススメする内容でした。

一方、失敗した手順の方にも一定のメリットはあると思っています。
呼び出されていることが多い層から削除することで、それを呼び出していた側で発生する静的解析によるエラーから次に削除すべきところを明らかにし順々に削除を進めていくことで、網羅的に削除できる利点があります。
しかし、この手順だと作業に区切りをつけるのが少し難しく、変更行数が大きくなりやすいです。安全に削除できているのかの確認が難しいです。
このデメリットをなくせるように、小さな単位でうまいこと作業をすすめることができるならば、この手順で進めても良いと思います。

本内容が、コードを削除する際の一助になれば幸いです。
