---
publication_name: "smartshopping"
title: "ã‚¸ãƒ§ãƒ–ã«å¯¾ã™ã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè£…ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go","ãƒ†ã‚¹ãƒˆ","è‡ªå‹•ãƒ†ã‚¹ãƒˆ"]
published: false
---

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä¸­å¿ƒã«é–‹ç™ºã‚’ã—ã¦ã„ã‚‹é‡å³¶ã¨ç”³ã—ã¾ã™ã€‚
æœ€è¿‘ã¯ã€å¼Šç¤¾ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã‚ã‚‹[ã‚¹ãƒãƒ¼ãƒˆãƒãƒƒãƒˆ](https://smartshopping.co.jp/)ã«å¯¾ã™ã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆã®æ‹¡å……ã‚’æ¨ã—é€²ã‚ã¦ã„ã¾ã™ã€‚
ã‚¹ãƒãƒ¼ãƒˆãƒãƒƒãƒˆã¯åœ¨åº«ã®é‡é‡ã‚’è¨ˆæ¸¬ã—ã€é–¾å€¤ã‚’ä¸‹å›ã£ãŸéš›ã«è‡ªå‹•ã§ç™ºæ³¨ã‚’è¡Œã†æ©Ÿèƒ½ã‚’æœ‰ã—ã¦ã„ã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ãã®ç™ºæ³¨æ©Ÿèƒ½ã€ç‰¹ã«ã‚¸ãƒ§ãƒ–ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦å…±æœ‰ã—ã¾ã™ã€‚
ç™ºæ³¨ã‚¸ãƒ§ãƒ–ã«å¯¾ã™ã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ä¸­ã§ã€ä¸‹è¨˜ã®èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

- ã©ã®ã‚ˆã†ã«ã—ã¦ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã‹
- ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œçµæœã¯ã©ã†è©•ä¾¡ã™ã‚‹ã‹

ã“ã‚Œã‚‰ã«å¯¾ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å…±æœ‰ã—ã¾ã™ã€‚

## ã©ã®ã‚ˆã†ã«ã—ã¦ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã‹

ç™ºæ³¨ã‚¸ãƒ§ãƒ–ã¯Cronã§å®šæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆã‚’ã—ãŸã„ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã©ã®ã‚ˆã†ã«ç™ºæ³¨å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‹ãŒèª²é¡Œã§ã—ãŸã€‚
ãã“ã§ã€ãƒ†ã‚¹ãƒˆç”¨ã®WebAPIã‚’ä½œæˆã—ã€ã“ã‚Œã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

å¼Šç¤¾ã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…ã¯ä¸‹è¨˜ãµãŸã¤ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ã€ã‚¸ãƒ§ãƒ–ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®å®Ÿè£…
  - ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®ãƒ‘ãƒ¼ã‚¹
  - DBæ¥ç¶šç­‰ã®ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®åˆæœŸåŒ–

ãƒ†ã‚¹ãƒˆã—ãŸã„ã‚‚ã®ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãªã®ã§ã€WebAPIã§ã‚¸ãƒ§ãƒ–ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å…¬é–‹ã—ã€ã“ã‚Œã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
ãã†ã™ã‚‹ã¨ã€Cronã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¸ãƒ§ãƒ–ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã§ãã¾ã™ã€‚
ã“ã®WebAPIã¯ã€ãƒ†ã‚¹ãƒˆç”¨ãªã®ã§ã€æœ¬ç•ªç’°å¢ƒã«ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã›ã‚“ã€‚

#### ç°¡å˜ãªå®Ÿè£…ä¾‹

```go
package main

import "net/http"

func main() {
	// ...productionç’°å¢ƒç”¨ã®ã‚³ãƒ¼ãƒ‰...

	// ...developmentç’°å¢ƒã§ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰...
	if env == Development {
		http.HandleFunc("/internal/order-job", func(w http.ResponseWriter, r *http.Request) {
			err := NewJobUsecase(
			// ...DI
			).Order()
			if err != nil {
				w.Write([]byte(err.Error()))
				return
			}
			w.Write([]byte("ok"))
			return
		})
		http.ListenAndServe(":8080", nil)
	}
}

type jobUsecaseImpl struct {
	// ...dependency
}

func (r *jobUsecaseImpl) Order() error {
	// ...ç™ºæ³¨ãƒ­ã‚¸ãƒƒã‚¯
	return nil
}

func NewJobUsecase() JobUsecase {
	return &jobUsecaseImpl{
		// ...DI
	}
}

type JobUsecase interface {
	Order() error
}

var env = "development"
const Development = "development"

```

##### å‘¼ã³å‡ºã—çµæœ

```
$ curl http://localhost:8080/internal/order-job
ok
```

## ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œçµæœã¯ã©ã†è©•ä¾¡ã™ã‚‹ã‹


ç™ºæ³¨ã‚¸ãƒ§ãƒ–ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’å®Ÿè¡Œã—ã€ç™ºæ³¨å‡¦ç†ã‚’ä¾é ¼ã—ã¾ã™ã€‚
å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«ä¾å­˜ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å ´åˆãƒ†ã‚¹ãƒˆã§ä¿è¨¼ã—ãŸã„ã‚‚ã®ã¯ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ç™ºæ³¨ä¾é ¼ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†éš›ã®ä»•æ§˜ãŒå®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€ã§ã™ã€‚
ãã“ã§ã€å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®éƒ¨åˆ†ã«ãƒ¢ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã€æ­£ã—ãå¼•æ•°ã«ç™ºæ³¨æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆ=ç™ºæ³¨ä¾é ¼ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ï¼‰ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€[å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹/ä½¿ã„æ–¹](https://book.mynavi.jp/ec/products/detail/id=134252)ã¨ã„ã†æœ¬ã®ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã«å¯¾ã—ã¦ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã¨åŠ¹æœçš„ãªãƒ†ã‚¹ãƒˆã«ãªã‚‹ã€ã¨ã„ã†è€ƒãˆæ–¹ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

> ã¾ãŸã€ç¬¬5ç« ã§è¦‹ãŸã‚ˆã†ã«ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€ãã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†éš›ã®ä»•æ§˜ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã¯ã€å¾Œæ–¹äº’æ›ã®ç¶­æŒã«ç¹‹ãŒã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®ã‚ˆã†ãªä¾å­˜ã«å¯¾ã—ã¦ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã“ã¨ã¯éå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚ãªãœãªã‚‰ã€ã“ã®ç¨®ã®ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯ã«ç½®ãæ›ãˆã¦ã„ã‚Œã°ã€ã©ã®ã‚ˆã†ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ãŸã¨ã—ã¦ã‚‚ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†éš›ã®ä»•æ§˜ãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚

[å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹/ä½¿ã„æ–¹](https://book.mynavi.jp/ec/products/detail/id=134252) p.270ã‚ˆã‚Šå¼•ç”¨

#### ç°¡å˜ãªå®Ÿè£…ä¾‹

[å…ˆã»ã©](#ç°¡å˜ãªå®Ÿè£…ä¾‹)å®Ÿè£…ã—ãŸã‚‚ã®ã®å·®åˆ†ã‚’è¼‰ã›ã¾ã™ã€‚
ãƒ¢ãƒƒã‚¯ã®å®Ÿè£…ã«ã¯ã€[moq](https://github.com/matryer/moq)ã¨ã„ã†ãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚

```go:
package main

import (
	"encoding/json"
	"github.com/HiromasaNojima/explain-order-job-test/orderapi"
	"net/http"
)

func main() {
	// ...productionç’°å¢ƒç”¨ã®ã‚³ãƒ¼ãƒ‰...

	// ...developmentç’°å¢ƒã§ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰...
	if env == Development {
		http.HandleFunc("/internal/order-job", func(w http.ResponseWriter, r *http.Request) {
			externalAPI := &orderapi.ExternalAPIMock{
				RequestOrderFunc: func(req orderapi.OrderInfo) error {
					return nil
				},
			}
			err := NewJobUsecase(
				// ...DI
				externalAPI,
			).Order()
			if err != nil {
				w.Write([]byte(err.Error()))
				return
			}
			// ç™ºæ³¨ç”¨APIã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸæ™‚ã®å€¤ã‚’å–å¾—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§è¿”å´ã—ã€å—ã‘å–ã‚Šå´ã§æ„å›³ã—ãŸé€šã‚Šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹è©•ä¾¡ã™ã‚‹ã€‚
			called := externalAPI.RequestOrderCalls()[0]
			b, err := json.Marshal(called)
			w.Write(b)
			return
		})
		http.ListenAndServe(":8080", nil)
	}
}

type jobUsecaseImpl struct {
	// ...dependency
	externalAPI orderapi.ExternalAPI
}

func (r *jobUsecaseImpl) Order() error {
	// ...ç™ºæ³¨ãƒ­ã‚¸ãƒƒã‚¯
	req := orderapi.OrderInfo{
		ProductName: "ç™ºæ³¨ã—ãŸã„å•†å“ã®åå‰",
	}
	// ...ç™ºæ³¨APIã®å‘¼ã³å‡ºã—
	err := r.externalAPI.RequestOrder(req)
	if err != nil {
		return err
	}
	return nil
}

func NewJobUsecase(externalAPI orderapi.ExternalAPI) JobUsecase {
	return &jobUsecaseImpl{
		// ...DI
		externalAPI: externalAPI,
	}
}
```

```go:å¤–éƒ¨API
package orderapi

type ExternalAPI interface {
	RequestOrder(request OrderInfo) error
}
type externalAPIImpl struct{}

type OrderInfo struct {
	// ..ç™ºæ³¨æƒ…å ±
	ProductName string `json:"product_name"`
}

func (r externalAPIImpl) RequestOrder(request OrderInfo) error {
	// å¤–éƒ¨APIå‘¼ã³å‡ºã—
	return nil
}
```

```go:å¤–éƒ¨APIã®ãƒ¢ãƒƒã‚¯
// Code generated by moq; DO NOT EDIT.
// github.com/matryer/moq

package orderapi

import (
	"sync"
)

// Ensure, that ExternalAPIMock does implement ExternalAPI.
// If this is not the case, regenerate this file with moq.
var _ ExternalAPI = &ExternalAPIMock{}

// ExternalAPIMock is a mock implementation of ExternalAPI.
//
// 	func TestSomethingThatUsesExternalAPI(t *testing.T) {
//
// 		// make and configure a mocked ExternalAPI
// 		mockedExternalAPI := &ExternalAPIMock{
// 			RequestOrderFunc: func(request OrderInfo) error {
// 				panic("mock out the RequestOrder method")
// 			},
// 		}
//
// 		// use mockedExternalAPI in code that requires ExternalAPI
// 		// and then make assertions.
//
// 	}
type ExternalAPIMock struct {
	// RequestOrderFunc mocks the RequestOrder method.
	RequestOrderFunc func(request OrderInfo) error

	// calls tracks calls to the methods.
	calls struct {
		// RequestOrder holds details about calls to the RequestOrder method.
		RequestOrder []struct {
			// Request is the request argument value.
			Request OrderInfo
		}
	}
	lockRequestOrder sync.RWMutex
}

// RequestOrder calls RequestOrderFunc.
func (mock *ExternalAPIMock) RequestOrder(request OrderInfo) error {
	if mock.RequestOrderFunc == nil {
		panic("ExternalAPIMock.RequestOrderFunc: method is nil but ExternalAPI.RequestOrder was just called")
	}
	callInfo := struct {
		Request OrderInfo
	}{
		Request: request,
	}
	mock.lockRequestOrder.Lock()
	mock.calls.RequestOrder = append(mock.calls.RequestOrder, callInfo)
	mock.lockRequestOrder.Unlock()
	return mock.RequestOrderFunc(request)
}

// RequestOrderCalls gets all the calls that were made to RequestOrder.
// Check the length with:
//     len(mockedExternalAPI.RequestOrderCalls())
func (mock *ExternalAPIMock) RequestOrderCalls() []struct {
	Request OrderInfo
} {
	var calls []struct {
		Request OrderInfo
	}
	mock.lockRequestOrder.RLock()
	calls = mock.calls.RequestOrder
	mock.lockRequestOrder.RUnlock()
	return calls
}
```

##### å‘¼ã³å‡ºã—çµæœ

```
curl http://localhost:8080/internal/order-job
{"Request":{"product_name":"ç™ºæ³¨ã—ãŸã„å•†å“ã®åå‰"}}
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æƒ³å®šé€šã‚Šã®å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã‚‰OKã§ã™ã€‚

## ã¾ã¨ã‚

ã‚¸ãƒ§ãƒ–ã«å¯¾ã™ã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¸ãƒ§ãƒ–ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆç”¨ã®APIã§å…¬é–‹ã™ã‚‹ã€ã¨ã„ã†æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

ä»–ã«ã¯æœ¬ç•ªç’°å¢ƒã¨åŒã˜ã‚ˆã†ã«ã‚¸ãƒ§ãƒ–ã‚’èµ·å‹•ã™ã‚‹æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã—ã‹ã—ã€ã“ã‚Œã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã‚³ã‚¹ãƒˆã®å¤§ãã•ã‚„æ™‚é–“çš„åˆ¶ç´„ã«ã‚ˆã‚Šã€ã¾ãŸã€ã‚¸ãƒ§ãƒ–ã®èµ·å‹•/çµ‚äº†ãŒæ­£ã—ãè¡Œã‚ã‚Œã‚‹ã“ã¨ã®æ‹…ä¿ã¯SREã®è²¬å‹™ã¨è€ƒãˆã¦ã„ã‚‹ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã¨åŒã˜ã‚ˆã†ã«ã‚¸ãƒ§ãƒ–ã‚’èµ·å‹•ã™ã‚‹æ–¹æ³•ã¯æ¡ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

æœ¬è¨˜äº‹ã®å†…å®¹ãŒã‚¸ãƒ§ãƒ–ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹éš›ã®è€ƒãˆæ–¹ã®ä¸€åŠ©ã¨ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## å‚è€ƒæ–‡çŒ®

- [å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹/ä½¿ã„æ–¹](https://book.mynavi.jp/ec/products/detail/id=134252)

## æœ¬æ–‡ä¸­ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

https://github.com/HiromasaNojima/explain-order-job-test