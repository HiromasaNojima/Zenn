---
title: "マイクロサービスアーキテクチャに Integration Test を導入しました"
emoji: "🔍"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

こんにちは、バックエンドを中心に開発をしています、野島といいます。
今回は、スマートショッピングにおいて、Integration Test（統合テスト）を導入したのでこちらを紹介します。
弊社では、マイクロサービスアーキテクチャを採用しており、その中のテストのひとつとしてIntegration Testを導入しました。

Integration Testについて説明や、なぜ導入しようと思ったのかについて書いたのちに、どのように実現しているのか、という技術的なことを書いてきます。

# Integration Test の本記事における定義

本記事では、Integration Testを下記の定義とします。

マイクロサービスが依存する外部コンポーネントをモック化せずに行うAPIテスト。
外部コンポーネントとは、具体的にはデータストア、外部サービス、テスト対象が依存するマイクロサービス、などを指します。
テスト対象のマイクロサービスが公開するAPI（WebAPI等）を介して自動テストを行います。

Integration Testという言葉が広範なものであり、イメージするものが人によって異なることが多いので、本記事での扱いを先に書かせていただきました。
かしこまって書きましたが、WebAPIの自動テストをするんだなぁ、テスト対象が依存するものは本物を使ってモックしないんだなぁ、ぐらいに捉えていただければと思います。

# なぜ Integration Test を導入するのか

次の理由があって、Integration Test導入を決意しました。

- 弊社で発生した障害を振り返ると、APIレベルのテストが存在すれば防げるものがあった
- Integration Testを導入することで複雑さに対応し、自信を持って開発するために
- テスト戦略を考えると、Integration Testの仕組みを導入したかった

## 弊社で発生した障害を振り返ると、APIレベルのテストが存在すれば防げるものがあった

弊社では、ポストモーテム共有会、という会を不定期に開催しています。
障害を振り返り、そこから学びを得よう。という会です。
その中で、これは「APIレベルの自動テストが存在すれば防げた」なぁ、と思うものがいくつかありました。

同じような障害を繰り返すのはよろしくないです。
再発を防ぐには仕組みが必要です。
それに、Integration Testがあれば、効きそうだと思い導入のきっかけのひとつになりました。

## Integration Testを導入することで複雑さに対応し、自信を持って開発しデプロイしていくために

事業、ソフトウェアの成長とともに、複雑さが増してくることは避けられないでしょう。機能が増えるにつれて、ソフトウェアは複雑になっていきます。
これにどう対応するかといえば、テストを書くのが良いと思っています。

テストを書くこことで、機能追加の際に既存の振る舞いを壊さないことや、期待通りの動作になることを確認できます。正しいことをしているという自信を開発者に与えてくれて、安心してデプロイできます。デプロイ頻度を上げて開発速度をあげてくにはテストが必要だと思います。
テストはUTだけでカバーできない領域があるので、そういった範囲をIntegration Testでカバーするために導入のモチベーションがありました。

## テスト戦略を考えると、Integration Testの仕組みを導入したかった

テストピラミッドという概念があります。
この中で、E2E,UTの仕組みはすでにあるのですが、Integration Testはなかったので導入したいという気持ちを高めました。

![テストピラミッドの画像](/images/test_pyramid.png)

詳しい解説はchat gpt先生にお願いしました。

![chat gpt によるテストピラミッドについて解説の画像1](/images/chat-gpt-test-pyramid-1.png)
![chat gpt によるテストピラミッドについて解説の画像2](/images/chat-gpt-test-pyramid-2.png)

テストピラミッドについてはいろいろ解説がありこれらが詳しいと思っています。
https://martinfowler.com/articles/practical-test-pyramid.html
https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html

# Integration Test の技術面でのお話

## 採用した技術

テストをCIに組み込むのに、[Argo workflow](https://github.com/argoproj/argo-workflows) を利用し、
テストケース自体は、[scenarigo](https://github.com/zoncoen/scenarigo) で実装します。

Argo workflow はワークフローエンジンで、次の理由で採用しました。

- [Argo events](https://argoproj.github.io/argo-events/)と組み合わせることで、[20以上のイベントソース](https://argoproj.github.io/argo-events/concepts/event_source/)からワークフローを発火できること

テストをCIに組み込むのに、テストを任意のタイミングで実行できると便利だと思うのですが、[Argo events](https://argoproj.github.io/argo-events/)と組み合わせることで、[20以上のイベントソース](https://argoproj.github.io/argo-events/concepts/event_source/)からワークフローを発火できます。今回はテストをワークフローに定義することとなり、これだけイベントソースに選択肢があればよきタイミングでテストを実行できそうです。
ただ後述しますが、現時点では[Argo workflowのAPI](https://argoproj.github.io/argo-workflows/events/)をwebhookで直に叩いているので、Argo eventsとはまだ組み合わせてません😢

- テストとは関係なく通常の開発業務でワークフローエンジンとして利用し、Jobの実行順序をコントロールできること

過去に自分が作ったJobで実行順序が重要なJobで、CronJobの実行時刻の前後で制御しているものがあり、こういったJobをArgo workflowで制御できたら安心できます。技術負債ですがクリティカルに業務に関わってくる部分ではないので許されている感があります。

scenarigo はAPIサーバーのシナリオテストを書けるツールで、次の理由で採用しました。

- テストシナリオをyamlでかけること
- pluginを実装すれば拡張できて、多様なケースに対応できること

その他有名どころだと、[newman](https://github.com/postmanlabs/newman)を採用することも考えましたが、jsonにテストがエクスポートされ可読性が低く、テストケースの管理がしにくい、というような不満を挙げている方が多かったのでやめました。

また、[runn](https://github.com/k1LoW/runn)もyamlでかけるし良さそうだなーとは思っていました。主観ですが、scernarigoとrunnを比べてみて、scernarigoの方がより素直にテストをかけ、学習コストが低そうだと判断したので、scenarigoにしました。

## 全体の仕組み

前提として、弊社では各環境でのデプロイをArgoCDで行っています。[こちらの弊社ブログの記事](https://tech.smartshopping.co.jp/smartmat_k8s_infrastructure)が詳しいです。また、開発環境上でIntegration Testの仕組みを作っています。テスト対象のマイクロサービスが依存するものは全て開発環境上のものを利用します。
それでは、これらの技術をどのように組み合わせているのか、図示します。

![Integration Test のシーケンス図](/images/integration-test-sequece-diagram.png)

1. featureブランチで開発者は作業し、main or development ブランチにPRを出しマージします
1. GitHub Actionsが動き、マージされた内容でマイクローサービスのイメージ、テストのイメージを固めてECRにpushします
1. Argo CDが、pushされたイメージを元にマイクロサービスをデプロイします
1. デプロイ時に、Initコンテナで Argo Workflow をwebhookをして、デプロイされたことを通知します
1. 通知を受け、Argo Workflowはテスト対象のマイクロサービスと、それが依存するマイクロサービスを対象にhealthcheckを実行します
1. healthcheckのレスポンスが全てOKとなった場合、2でpuhしたテストのイメージを使って、テストを実行します
1. テストが完了したら、開発者に通知をだします。今はslackで通知しています

テスト実行の様子はこのようにArgo workflowから確認できます。

(画像)

また、テストのログもこういった形で確認できます。

(画像)

## 今後の展望

導入したばかりなのでまだまだやりたいことはたくさんあります。
今はテストの結果をみて、安全そうなら手で本番環境デプロイ用のPRをマージして本番環境反映というような形になっています。が、このテストがOKになるまでマージできない等の仕組みができたらより安全になると思っています。あるいは、featureブランチをマージする前にテストが実行できて、それがOKになるまでマージできない、というような仕組みがあればかなり理想系です。
また、テストケース自体も一部のマイクロサービスを対象にしか実装できていないので横展開していきたいです。

今後も、またテスト関連で記事を書くと思うので、経過なども共有できたらなと思います。
最後までお読みいただきありがとうございました。