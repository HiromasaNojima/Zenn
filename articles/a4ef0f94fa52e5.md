---
publication_name: "smartshopping"
title: "マイクロサービスアーキテクチャへのIntegration Test 導入のすゝめ"
emoji: "🎤"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

こんにちは、バックエンドを中心に開発をしています、野島といいます。
2023/12/09に開催されたソフトウェアテスト自動化カンファレンス2023に「マイクロサービスアーキテクチャへのIntegration Test導入のすゝめ」という内容で登壇しました。
そちらで発表した内容を記事にしつつ、当日話しきれなかった内容についても書きます。

発表は下記の内容を話しました。

1. Integration Testの導入を決意した背景にあった課題
1. Integration Testの導入・運用での工夫
1. Integration Testを導入して得られたメリット

--スライド

## Integration Testの導入を決意した背景にあった課題

大きくわけてふたつの課題が存在していました。
順を追って説明していきます。

1. E2Eでカバーしきれない領域に重要な機能が存在する
1. マイクロサービスアーキテクチャの難しさ

### E2Eでカバーしきれない領域に重要な機能が存在する

弊社では在庫管理プロダクトを開発していますが、次の重要な機能が存在します。

1. 在庫数の推定: IoT重量計を用いて、重量ベースで在庫数を算出
1. 在庫の自動発注: 在庫数の変動に応じて、在庫を補充するために自動で発注を行う

#### 在庫数の推定: IoT重量計を用いて、重量ベースで在庫数を算出

![在庫数推定の課題感](/images/IT-kadai-subscription.png)

![在庫数の推定](/images/subscription-description.gif)

直感的にわかるようにgifを利用して説明します。
本をIoT重量計に乗せると、重量を計測し在庫数を算出、画面上に表示されます。 
在庫数の推定は、重量を計測するIoT重量計からのリクエストから始まります。リクエストで送信された重量を利用して最終的に在庫数がどれだけあるか、という結果を算出します。
このgifの場合、本を3冊重ねてIoT重量に載せているので、結果とし在庫数が3であるという結果が得られました。

この機能は、IoTデバイスがトリガーとなる処理です。そのため画面トリガーでテストするような一般的なE2Eテストのカバー範囲外になります。

#### 在庫の自動発注: 在庫数の変動に応じて、在庫を補充するために自動で発注を行う

![発注の課題感](/images/it-kadai-order.png)

![在庫の自動発注](/images/order-description.png)

画像の左側のグラフは、青い線が在庫数の変動を表しています。
黄色い線が閾値、発注点を表しています。
在庫数を示す青い線が、閾値を示す黄色い線を下回った場合、自動で発注する機能が存在します。
自動発注がおこなわれると、画像の右側のようなメールが送信され、発注処理がおこなわれます。

この機能は、Cronで定期的に実行されるJOBで行われています。
そのため画面トリガーでテストするような一般的なE2Eテストのカバー範囲外になります。

![E2Eでカバーしきれない領域に重要な機能が存在する](/images/IT-kadai-NOT-covering-e2e.png)

紹介したような機能が、弊社のプロダクトでは重要なものになっており、これらがE2Eでカバーしきれない領域に存在することに課題感がありました。

### マイクロサービスアーキテクチャの難しさ

![マイクロサービスアーキテクチャの難しさ](/images/IT-kadai-difficulty-of-MS.png)

弊社では、マイクロサービスアーキテクチャを採用しています。
マイクロサービスアーキテクチャでは、サービス間の通信が発生し、ひとつのサービスで処理が完結しないことがあり、そこが難しさのひとつです。
[E2Eでカバーしきれない領域に重要な機能が存在する]()で紹介した、[在庫推定]()、[自動発注]()の機能ですが、これらには複数のサービスが関わります。
複数のサービスが依存に現れてくると、単一のサービスの一部のロジックにUTを書いても、サービス間を繋げて動作させた時に本当に正しく動くかについて自信を持つことが難しいです。

![Integration Test の導入へ](/images/to-inroduce-IT.png)

Integration Testを導入する前に、先行してUT,E2Eが存在しましたが、これら重要機能が既存のテストでカバーすることができていない状態でした。
重要機能がテストでカバーしきれていないことが、デプロイの不安要素になっていました。
当事、弊社では開発生産性をあげよう、デプロイ頻度を上げよう、という取り組みがあり、デプロイ頻度を上げるには不安要素を取り除く必要がありました。
そこで、Integration Testを導入することにしました。

## Integration Testの導入・運用での工夫

xxx

## Integration Testを導入して得られたメリット

xxx

## まとめ

## 登壇した感想