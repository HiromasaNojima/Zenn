---
title: "ã€Argo Workflowsã€‘workflow ã‚’ webhook ã§ç™ºç«ã™ã‚‹ / WorkflowEventBinding"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["argo", "kubernetes"]
published: false
---

# æœ¬è¨˜äº‹ã®ç›®çš„

https://argoproj.github.io/argo-workflows/events/

Argo Workflowsã®å°å…¥ã‹ã‚‰é€²ã‚ã€ä¸Šè¨˜documentã§è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å®Ÿè·µã—ã¾ã™ã€‚
ç§ã®k8såŠ›ã®ä½ã•ãŒåŸå› ã‹ã€å˜ç´”ã«documenté€šã‚Šã«é€²ã‚ã‚‹ã“ã¨ã™ã‚‰è‹¦æˆ¦ã—ãŸã®ã§ã€ãã†ã„ã£ãŸæ–¹ã®åŠ©ã‘ã«ãªã‚Œã°ã¨ğŸ’ª

## ç’°å¢ƒ

minikubeã‚’åˆ©ç”¨ã—ã¦é€²ã‚ã¾ã™ã€‚

```
% minikube version
minikube version: v1.27.0
commit: 4243041b7a72319b9be7842a7d34b6767bbdac2b
```

Argo Workflows ã¯ v3.4.1 ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

# Argo Workflowsã®å°å…¥

https://argoproj.github.io/argo-workflows/quick-start/

Quick Start ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚

> To install Argo Workflows, navigate to the releases page and find the release you wish to use (the latest full release is preferred).
> 
> Scroll down to the Controller and Server section and execute the kubectl commands.

[v3.4.1ã®ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸](https://github.com/argoproj/argo-workflows/releases/tag/v3.4.1)ã«ã„ãã€Controller and Server ã« è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
kubectl create namespace argo
kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.4.1/install.yaml
```

:::details no matches for kind "Certificate" in version "cert-manager.io/v1" ensure CRDs are installed first ã¨æ€’ã‚‰ã‚ŒãŸå ´åˆ

[cert-manager](https://github.com/cert-manager/cert-manager)ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ€’ã‚‰ã‚Œã‚‹ã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
æ€’ã‚‰ã‚Œãªã‹ã£ãŸæ–¹ã«ã¯é–¢ä¿‚ãªã„ã®ã§ã€æœ¬ç¯€ã¯é£›ã°ã—ã¦OKã§ã™ğŸ™†â€â™‚ï¸

```
kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.4.1/install.yaml
namespace/argo created
.....(ç•¥).....
resource mapping not found for name: "argo-server-cert" namespace: "argo" from "https://github.com/argoproj/argo-workflows/releases/download/v3.4.1/install.yaml": no matches for kind "Certificate" in version "cert-manager.io/v1"
ensure CRDs are installed first
resource mapping not found for name: "argo-workflows-issuer" namespace: "argo" from "https://github.com/argoproj/argo-workflows/releases/download/v3.4.1/install.yaml": no matches for kind "Issuer" in version "cert-manager.io/v1"
```

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ https://cert-manager.io/docs/installation/

```
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml
```

:::

Auth Mode ã‚’ `server` ã«å¤‰æ›´ã—ã¾ã™ã€‚

```
kubectl patch deployment \
  argo-server \
  --namespace argo \
  --type='json' \
  -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/args", "value": [
  "server",
  "--auth-mode=server"
]}]'
```

port-forward ã—ã¦ UIã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

```
kubectl -n argo port-forward deployment/argo-server 2746:2746
```

https://localhost:2746 ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ã²ã‚‰ã‘ã°ã€Argo Workflows ã® UI ãŒç¢ºèªã§ãã¾ã™ğŸ˜

![uiã®ç”»åƒ](/images/argo-workflows-gui.png)

# WorkflowTemplate, WorkflowEventBinding ã‚’ä½œæˆã—ã¦ã€webhook ã§ç™ºç«

https://argoproj.github.io/argo-workflows/events/

æœ¬è¨˜äº‹å†’é ­ã«æŒ™ã’ãŸãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’é€²ã‚ã¾ã™ã€‚

## WorkflowTemplate ã®ä½œæˆ

WorkflowTemplate ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: my-wf-tmple
  namespace: argo
spec:
  templates:
    - name: main
      inputs:
        parameters:
          - name: message
            value: "{{workflow.parameters.message}}"
      container:
        image: docker/whalesay:latest
        command: [cowsay]
        args: ["{{inputs.parameters.message}}"]
  entrypoint: main
```

`workflow-template-sample.yaml`ã€€ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¸Šè¨˜ã‚’ä¿å­˜ã—ã¦ apply ã—ã¾ã™ã€‚

```
kubectl apply -f workflow-template-sample.yaml -n argo
```

https://localhost:2746/workflow-templates/argo ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ğŸ˜

![workflow-templateã®ç”»åƒ](/images/workflow-template-sample.png)


## WorkflowEventBindingã®ä½œæˆ

WorkflowEventBindingã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowEventBinding
metadata:
  name: event-consumer
spec:
  event:
    # metadata header name must be lowercase to match in selector
    selector: payload.message != "" && metadata["x-argo-e2e"] == ["true"] && discriminator == "my-discriminator"
  submit:
    workflowTemplateRef:
      name: my-wf-tmple
    arguments:
      parameters:
      - name: message
        valueFrom:
          event: payload.message
```

`workflow-event-binding-sample.yaml`ã€€ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¸Šè¨˜ã‚’ä¿å­˜ã—ã¦ apply ã—ã¾ã™ã€‚

```
kubectl apply -f workflow-event-binding-sample.yaml -n argo
```

https://localhost:2746/workflow-event-bindings/argo ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ğŸ˜

![workflow-event-bindingã®ç”»åƒ](/images/workflow-event-bindings-sample.png)

event ã¨ template ãŒç´ã¥ã‘ã‚‰ã‚ŒãŸã“ã¨ãŒç›´æ„Ÿçš„ã«ç†è§£ã§ãã¾ã™ã€‚

## ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã¦ã€webhookã§ç™ºç«

ã•ã¦ã€webhookã§ã™ãã«ç™ºç«ã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ãã®ãŸã‚ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆ

https://argoproj.github.io/argo-workflows/webhooks/

ã“ã¡ã‚‰ã®å†…å®¹ã‚’é€²ã‚ã¾ã™ã€‚

Role, ServiceAccount ã‚’ä½œæˆã—ã¦ã€ServiceAccountã¨Roleã‚’ç´ã¥ã‘ã¾ã™ã€‚
[Service account token Secrets](https://kubernetes.io/ja/docs/concepts/configuration/secret/#service-account-token-secrets) ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
# Just enough permissions to submit a workflow template.
# You could tighten this further (but perhaps impractically) by using `resourceNames`
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: submit-workflow-template
rules:
  - apiGroups:
      - argoproj.io
    resources:
      - workfloweventbindings
    verbs:
      - list
  - apiGroups:
      - argoproj.io
    resources:
      - workflowtemplates
    verbs:
      - get
  - apiGroups:
      - argoproj.io
    resources:
      - workflows
    verbs:
      - create
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: webhook-client
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name:  webhook-client
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: submit-workflow-template
subjects:
  - kind: ServiceAccount
    name:  webhook-client
    namespace: argo
---
apiVersion: v1
kind: Secret
metadata:
  name: webhook-client-token
  namespace: argo
  annotations:
    kubernetes.io/service-account.name: "webhook-client"
type: kubernetes.io/service-account-token
```

`account-role-token-sample.yaml` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¸Šè¨˜ã‚’ä¿å­˜ã—ã¦ apply ã—ã¾ã™ã€‚

```
kubectl apply -f account-role-token-sample.yaml -n argo
```

ä½œæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€å¤‰æ•° `$ARGO_TOKEN` ã«ä¿å­˜ã—ã¾ã™ã€‚

```
ARGO_TOKEN="Bearer $(kubectl get secret -n argo webhook-client-token -o jsonpath='{.data.token}' | base64 --decode)"
```

`$ARGO_TOKEN` ã‚’ç¢ºèªã—ã¾ã™ğŸ˜

```
% echo $ARGO_TOKEN
Bearer eyJhbGciOiJSUzI1NiIs....
```

### webhookã§ç™ºç«

ãƒˆãƒ¼ã‚¯ãƒ³ãŒä½œæˆã§ããŸã®ã§ç™ºç«ã—ã¾ã™ã€‚
ä¸‹è¨˜ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
curl -k https://localhost:2746/api/v1/events/argo/my-discriminator \
    -H "Authorization: $ARGO_TOKEN" \
    -H "X-Argo-E2E: true" \
    -d '{"message": "hello events"}'
```

UIã‹ã‚‰ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ğŸ˜

![workflow-templateã®ç”»åƒ](/images/webhook-log.png)

message ã§æŒ‡å®šã—ãŸã€hello events ãŒå¤‰æ•°ã§æ¸¡ã•ã‚Œã¦ workflowãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€œã€‚
